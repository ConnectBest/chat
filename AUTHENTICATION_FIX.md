# Authentication Fix - Complete Frontend-Backend Integration

## Date: December 7, 2025

## Problem Statement

The Next.js frontend authentication was not properly integrated with the Flask backend JWT token system. This caused authentication failures when making API calls from the frontend to the backend.

## Root Cause Analysis

### Issue 1: No Flask-Compatible JWT Token Generation

**Location:** `/lib/auth.ts` - NextAuth.js configuration

**Problem:**
- NextAuth was only creating its own session tokens
- No Flask-compatible JWT token was being generated
- The `accessToken` field in the session contained the entire NextAuth JWT object instead of a Flask-compatible token string
- Flask backend expects JWT tokens signed with `JWT_SECRET_KEY` in `Authorization: Bearer <token>` header

**Impact:**
- API calls from Next.js to Flask failed authentication
- Backend couldn't validate the NextAuth session tokens
- Users couldn't perform authenticated operations

### Issue 2: API Routes Not Sending JWT Tokens

**Location:** `/app/api/**/*.ts` - All API proxy routes

**Problem:**
- API routes were sending custom headers (`X-User-ID`, `X-User-Email`, `X-User-Role`) instead of proper JWT tokens
- Flask backend's `@token_required` decorator expects `Authorization: Bearer <token>` header
- While the backend had a fallback to accept headers, this was insecure and didn't match the documented architecture

**Impact:**
- Insecure authentication flow
- Inconsistent with OAuth and direct API access patterns
- Didn't leverage Flask's JWT validation capabilities

### Issue 3: Missing JWT Secret Configuration

**Location:** `.env.example` and frontend configuration

**Problem:**
- No `JWT_SECRET_KEY` environment variable defined for frontend
- Frontend and backend JWT secrets were not synchronized
- No documentation about the requirement for matching secrets

**Impact:**
- JWT tokens generated by frontend couldn't be validated by backend
- Configuration confusion between NEXTAUTH_SECRET and JWT_SECRET_KEY

## Solution Implementation

### Fix 1: Generate Flask-Compatible JWT Tokens in NextAuth

**File:** `/Users/mkennedy/repos/ConnectBest/chat/lib/auth.ts`

**Changes:**

1. **Added JWT Generation Function** (lines 8-63):
   ```typescript
   function generateFlaskJwt(userId: string, email: string, role: string, name?: string, phone?: string): string {
     // Uses Node.js crypto module to create HS256 JWT
     // Matches Flask PyJWT token format exactly
     // Includes: user_id, id, sub, email, role, name, phone, iat, exp
   }
   ```

2. **Updated JWT Callback** (lines 233-259):
   ```typescript
   async jwt({ token, user, account }) {
     if (user) {
       // ... existing user data ...

       // Generate Flask-compatible JWT token
       const flaskJwt = generateFlaskJwt(
         token.id as string,
         token.email as string,
         token.role as string,
         token.name as string | undefined,
         token.phone as string | undefined
       );

       token.flaskAccessToken = flaskJwt;
     }
     return token;
   }
   ```

3. **Updated Session Callback** (lines 260-269):
   ```typescript
   async session({ session, token }) {
     if (session.user) {
       // ... existing user data ...

       // CRITICAL FIX: Include Flask-compatible JWT token
       (session.user as any).accessToken = token.flaskAccessToken;
     }
     return session;
   }
   ```

**Technical Details:**
- JWT generated using Node.js built-in `crypto` module (no external dependencies)
- Token format: `{header}.{payload}.{signature}` (standard JWT structure)
- Algorithm: HMAC-SHA256 (HS256)
- Payload includes all fields expected by Flask backend
- Token signed with `JWT_SECRET_KEY` environment variable
- Expiration matches Flask configuration (default: 168 hours = 7 days)

### Fix 2: Create Utility Function for Authenticated Requests

**File:** `/Users/mkennedy/repos/ConnectBest/chat/lib/apiUtils.ts`

**Changes:**

1. **Updated getUserHeaders()** (lines 16-46):
   ```typescript
   export async function getUserHeaders(request: NextRequest) {
     const session = await auth(request as any, {} as any);

     if (!session?.user) {
       return null;
     }

     // Extract Flask-compatible JWT token
     const accessToken = (session.user as any).accessToken;

     if (!accessToken) {
       return null;
     }

     // Create headers with JWT Bearer token
     const headers: Record<string, string> = {
       'Content-Type': 'application/json',
       'Authorization': `Bearer ${accessToken}`,
       // Keep user headers as fallback
       'X-User-ID': (session.user as any).id,
       'X-User-Email': session.user.email || '',
       'X-User-Role': (session.user as any).role || 'user'
     };

     return { session, headers };
   }
   ```

2. **Added authenticatedFetch()** (lines 48-79):
   ```typescript
   export async function authenticatedFetch(
     endpoint: string,
     request: NextRequest,
     options: RequestInit = {}
   ): Promise<Response> {
     const authData = await getUserHeaders(request);

     if (!authData) {
       throw new Error('Authentication required');
     }

     // Merge headers and make request
     return fetch(`${backendUrl}${endpoint}`, {
       ...options,
       headers: {
         ...authData.headers,
         ...options.headers,
       },
     });
   }
   ```

### Fix 3: Update API Proxy Routes

**Files Updated:**
- `/Users/mkennedy/repos/ConnectBest/chat/app/api/auth/me/route.ts`
- `/Users/mkennedy/repos/ConnectBest/chat/app/api/users/me/route.ts`
- `/Users/mkennedy/repos/ConnectBest/chat/app/api/chat/channels/route.ts`
- `/Users/mkennedy/repos/ConnectBest/chat/app/api/chat/channels/[channelId]/messages/send/route.ts`
- `/Users/mkennedy/repos/ConnectBest/chat/app/api/upload/message-file/route.ts`

**Pattern Applied:**

**Before:**
```typescript
const session = await auth(request as any, {} as any);
const headers = {
  'X-User-ID': session.user.id,
  'X-User-Email': session.user.email,
  'X-User-Role': session.user.role
};
```

**After:**
```typescript
const authData = await getUserHeaders(request);
if (!authData) {
  return NextResponse.json({ error: 'Authentication required' }, { status: 401 });
}
// authData.headers includes: Authorization: Bearer <token> + X-User-* headers
const response = await fetch(url, { headers: authData.headers });
```

**Special Case - File Uploads:**
For multipart/form-data requests, Content-Type header is omitted to allow browser to set the correct boundary:
```typescript
const headers: Record<string, string> = {
  'Authorization': authData.headers['Authorization'],
  'X-User-ID': authData.headers['X-User-ID'],
  'X-User-Email': authData.headers['X-User-Email'],
  'X-User-Role': authData.headers['X-User-Role']
  // NO Content-Type header for multipart
};
```

### Fix 4: Update Environment Configuration

**File:** `/Users/mkennedy/repos/ConnectBest/chat/.env.example`

**Changes:**

Added JWT configuration variables (lines 19-27):
```bash
# CRITICAL: JWT Secret Key for Flask backend compatibility
# This MUST match the JWT_SECRET_KEY in backend/.env
JWT_SECRET_KEY=your-jwt-secret-key-change-this-in-production

# JWT token expiration in hours (default: 168 = 7 days)
JWT_EXPIRATION_HOURS=168
```

## Configuration Requirements

### Frontend (.env.local)

**Required Variables:**
```bash
# NextAuth configuration
NEXTAUTH_SECRET=your-nextauth-secret
NEXTAUTH_URL=http://localhost:8080

# CRITICAL: Must match backend JWT_SECRET_KEY
JWT_SECRET_KEY=your-jwt-secret-key
JWT_EXPIRATION_HOURS=168

# Backend URLs
NEXT_PUBLIC_API_URL=http://localhost:5001/api
NEXT_PUBLIC_WS_URL=http://localhost:5001
BACKEND_URL=http://localhost:5001

# MongoDB (for NextAuth direct DB access)
MONGODB_URI=mongodb://localhost:27017/chatapp
MONGODB_DB_NAME=chatapp

# Google OAuth (optional)
GOOGLE_CLIENT_ID=your-google-client-id
GOOGLE_CLIENT_SECRET=your-google-client-secret
```

### Backend (backend/.env)

**Required Variables:**
```bash
# CRITICAL: Must match frontend JWT_SECRET_KEY
JWT_SECRET_KEY=your-jwt-secret-key
JWT_EXPIRATION_HOURS=168

# Flask configuration
SECRET_KEY=your-flask-secret
FLASK_ENV=development

# MongoDB
MONGODB_URI=mongodb://localhost:27017/chatapp
MONGODB_DB_NAME=chatapp

# CORS (must include frontend URLs)
CORS_ORIGINS=http://localhost:3000,http://localhost:8080

# URLs
FRONTEND_URL=http://localhost:8080
BACKEND_URL=http://localhost:5001
```

## Authentication Flow

### 1. User Login

```
User → Next.js /login
  ↓
NextAuth Credentials Provider
  ↓
MongoDB User Validation (bcrypt password check)
  ↓
JWT Callback: generateFlaskJwt()
  ↓
Session Callback: store flaskAccessToken in session.user.accessToken
  ↓
Session Cookie Set (authjs.session-token)
```

### 2. API Request

```
Frontend Component → api.listChannels()
  ↓
Next.js API Route: /api/chat/channels
  ↓
getUserHeaders(request)
  ├─ Validate NextAuth session
  ├─ Extract session.user.accessToken (Flask JWT)
  └─ Create headers with Authorization: Bearer <token>
  ↓
Fetch to Flask: http://localhost:5001/api/chat/channels
  Headers:
    Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGc...
    X-User-ID: 507f1f77bcf86cd799439011
    X-User-Email: user@example.com
    X-User-Role: user
  ↓
Flask @token_required Decorator
  ├─ Check Authorization header
  ├─ Decode JWT with JWT_SECRET_KEY
  ├─ Verify signature and expiration
  ├─ Fallback to X-User-* headers if token fails
  └─ Set request.current_user
  ↓
Flask Route Handler
  ↓
Response → Next.js API Route → Frontend
```

### 3. Token Validation (Flask)

```python
# Flask backend: utils/auth.py

def token_required(f):
    def decorated(*args, **kwargs):
        # 1. Try user headers first (Next.js API route)
        user_payload = extract_user_from_headers()

        if user_payload:
            request.current_user = user_payload
            return f(*args, **kwargs)

        # 2. Fallback to JWT token validation
        auth_header = request.headers.get('Authorization')

        if not auth_header:
            return {'error': 'Unauthorized'}, 401

        token = auth_header.split()[1]  # Extract from "Bearer <token>"
        user_payload = verify_nextauth_token(token)

        if not user_payload:
            return {'error': 'Invalid token'}, 401

        request.current_user = user_payload
        return f(*args, **kwargs)

    return decorated
```

## Security Considerations

1. **Secret Synchronization:** JWT_SECRET_KEY MUST be identical in frontend and backend
2. **Token Expiration:** Tokens expire after JWT_EXPIRATION_HOURS (default: 7 days)
3. **HTTPS Required:** In production, use HTTPS for all API calls
4. **Cookie Security:** NextAuth session cookies are httpOnly and secure in production
5. **Dual Authentication:** Backend accepts both JWT tokens and user headers for flexibility
6. **No Token Storage:** JWT tokens are never stored in localStorage (only in httpOnly cookies)

## Testing Checklist

- [ ] Login with email/password creates valid NextAuth session
- [ ] Login with Google OAuth creates valid NextAuth session
- [ ] Session contains accessToken (Flask-compatible JWT)
- [ ] API calls to Flask backend succeed with JWT token
- [ ] Flask backend validates JWT signature correctly
- [ ] Token expiration is enforced
- [ ] Logout clears session and invalidates tokens
- [ ] File uploads work with JWT authentication
- [ ] Real-time Socket.IO connection authenticates properly
- [ ] Admin routes enforce role-based access control

## Rollback Plan

If issues occur:

1. **Revert to Header-Only Authentication:**
   - Comment out Authorization header in `apiUtils.ts`
   - Keep only X-User-* headers
   - Backend will fallback to header validation

2. **Disable JWT Generation:**
   - Remove flaskAccessToken assignment in auth.ts
   - Frontend will fail gracefully, backend uses headers

3. **Emergency Bypass:**
   - Set DISABLE_AUTH=true in backend .env
   - All routes become public (development only!)

## Future Improvements

1. **Token Refresh:** Implement JWT refresh token mechanism
2. **Token Revocation:** Add token blacklist in Redis
3. **Rate Limiting:** Limit token generation/validation attempts
4. **Audit Logging:** Log all authentication events
5. **2FA Integration:** Add two-factor authentication flow
6. **Session Management:** Admin dashboard to view/revoke sessions

## Related Files

### Modified Files:
- `/lib/auth.ts` - NextAuth configuration with JWT generation
- `/lib/apiUtils.ts` - Authenticated request utilities
- `/app/api/auth/me/route.ts` - User info endpoint
- `/app/api/users/me/route.ts` - User profile endpoint
- `/app/api/chat/channels/route.ts` - Channels list endpoint
- `/app/api/chat/channels/[channelId]/messages/send/route.ts` - Send message endpoint
- `/app/api/upload/message-file/route.ts` - File upload endpoint
- `.env.example` - Environment variable documentation

### Backend Files (Reference):
- `backend/utils/auth.py` - JWT validation decorators
- `backend/routes/auth.py` - Authentication routes
- `backend/.env.example` - Backend configuration

### Documentation:
- `AUTHENTICATION_GUIDE.md` - Original authentication documentation
- `DEPLOYMENT_GUIDE.md` - Production deployment guide
- `CLAUDE.md` - Project architecture overview

## Contact

For questions or issues with this fix, refer to:
- AUTHENTICATION_GUIDE.md for detailed authentication flow
- CLAUDE.md for overall architecture
- Backend logs: `backend/logs/`
- Frontend console for JWT generation logs
