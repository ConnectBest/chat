#!/bin/bash

# ConnectBest Chat Application Architecture Overview
# This script provides a comprehensive overview of the application architecture

set -e

echo "ğŸ—ï¸  ConnectBest Chat Application Architecture"
echo "=============================================="
echo ""

# Color codes for better visualization
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

echo -e "${BLUE}ğŸ“‹ OVERVIEW${NC}"
echo "============"
echo "â€¢ Full-stack real-time chat application"
echo "â€¢ Microservices architecture on AWS ECS Fargate"
echo "â€¢ Multi-container deployment with ALB routing"
echo "â€¢ Serverless WebSocket API for real-time messaging"
echo "â€¢ MongoDB Atlas for data persistence"
echo ""

echo -e "${GREEN}ğŸ—ï¸  ARCHITECTURE LAYERS${NC}"
echo "======================"
echo ""

echo -e "${CYAN}â”Œâ”€ FRONTEND LAYER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”${NC}"
echo "â”‚ Technology: Next.js 15 (App Router)             â”‚"
echo "â”‚ Runtime: Node.js 18                             â”‚"
echo "â”‚ Container: Frontend Container (Port 3000)       â”‚"
echo "â”‚ Features:                                        â”‚"
echo "â”‚  â€¢ Server-side rendering (SSR)                  â”‚"
echo "â”‚  â€¢ Static file serving                          â”‚"
echo "â”‚  â€¢ NextAuth.js authentication                   â”‚"
echo "â”‚  â€¢ Tailwind CSS styling                         â”‚"
echo "â”‚  â€¢ TypeScript                                   â”‚"
echo -e "${CYAN}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${NC}"
echo ""

echo -e "${YELLOW}â”Œâ”€ API LAYER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”${NC}"
echo "â”‚ Technology: Flask (Python 3.12)                 â”‚"
echo "â”‚ Runtime: Gunicorn + Eventlet                    â”‚"
echo "â”‚ Container: Backend Container (Port 5001)        â”‚"
echo "â”‚ Features:                                        â”‚"
echo "â”‚  â€¢ REST API endpoints                           â”‚"
echo "â”‚  â€¢ JWT authentication                           â”‚"
echo "â”‚  â€¢ File upload handling                         â”‚"
echo "â”‚  â€¢ Socket.IO integration                        â”‚"
echo "â”‚  â€¢ MongoDB ODM                                  â”‚"
echo -e "${YELLOW}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${NC}"
echo ""

echo -e "${PURPLE}â”Œâ”€ REAL-TIME LAYER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”${NC}"
echo "â”‚ Technology: AWS API Gateway WebSocket + Lambda  â”‚"
echo "â”‚ Runtime: Node.js 20 (Serverless)               â”‚"
echo "â”‚ Storage: DynamoDB (Connection tracking)         â”‚"
echo "â”‚ Features:                                        â”‚"
echo "â”‚  â€¢ Real-time message delivery                   â”‚"
echo "â”‚  â€¢ Connection management                        â”‚"
echo "â”‚  â€¢ Channel-based routing                        â”‚"
echo "â”‚  â€¢ Auto-scaling                                 â”‚"
echo -e "${PURPLE}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${NC}"
echo ""

echo -e "${RED}â”Œâ”€ DATA LAYER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”${NC}"
echo "â”‚ Database: MongoDB Atlas (Cloud)                 â”‚"
echo "â”‚ Collections:                                     â”‚"
echo "â”‚  â€¢ users (authentication, profiles)             â”‚"
echo "â”‚  â€¢ channels (chat rooms, permissions)           â”‚"
echo "â”‚  â€¢ messages (content, threads, reactions)       â”‚"
echo "â”‚  â€¢ message_files (file attachments)             â”‚"
echo "â”‚  â€¢ user_channel_read (read receipts)            â”‚"
echo "â”‚  â€¢ threads (reply tracking)                     â”‚"
echo -e "${RED}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${NC}"
echo ""

echo -e "${BLUE}ğŸ”€ REQUEST FLOW${NC}"
echo "==============="
echo ""
echo "â”Œâ”€ User Browser â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
echo "â”‚                                                                        â”‚"
echo "â”‚  Frontend (Next.js)          API Calls              Backend (Flask)   â”‚"
echo "â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚"
echo "â”‚  â”‚   Port 3000 â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ ALB Routing  â”‚â”€â”€â”€â”€â”€â”€â–ºâ”‚   Port 5001  â”‚  â”‚"
echo "â”‚  â”‚             â”‚   /          â”‚              â”‚  /api â”‚              â”‚  â”‚"
echo "â”‚  â”‚ â€¢ Pages     â”‚              â”‚ Path-Based   â”‚       â”‚ â€¢ REST API   â”‚  â”‚"
echo "â”‚  â”‚ â€¢ Componentsâ”‚              â”‚ Routing      â”‚       â”‚ â€¢ Auth       â”‚  â”‚"
echo "â”‚  â”‚ â€¢ Static    â”‚              â”‚              â”‚       â”‚ â€¢ Database   â”‚  â”‚"
echo "â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚"
echo "â”‚                                      â”‚                       â”‚         â”‚"
echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
echo "                                       â”‚                       â”‚"
echo "                                       â–¼                       â–¼"
echo "                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
echo "                            â”‚ AWS WebSocket   â”‚     â”‚ MongoDB Atlas  â”‚"
echo "                            â”‚ API Gateway     â”‚     â”‚                â”‚"
echo "                            â”‚ + Lambda        â”‚     â”‚ â€¢ Documents    â”‚"
echo "                            â”‚ + DynamoDB      â”‚     â”‚ â€¢ Indexes      â”‚"
echo "                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚ â€¢ Replication  â”‚"
echo "                                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
echo ""

echo -e "${GREEN}ğŸ—ï¸  AWS INFRASTRUCTURE${NC}"
echo "======================"
echo ""
echo "ECS Fargate Cluster: chat-app-cluster"
echo "â”œâ”€â”€ Task Definition: chat-app (Multi-container)"
echo "â”‚   â”œâ”€â”€ Frontend Container (chat-frontend:latest)"
echo "â”‚   â”‚   â”œâ”€â”€ Image: ECR Private/Public"
echo "â”‚   â”‚   â”œâ”€â”€ CPU: 256, Memory: 512MB"
echo "â”‚   â”‚   â”œâ”€â”€ Port: 3000"
echo "â”‚   â”‚   â””â”€â”€ Health Check: /"
echo "â”‚   â””â”€â”€ Backend Container (chat-backend:latest)"
echo "â”‚       â”œâ”€â”€ Image: ECR Private/Public"
echo "â”‚       â”œâ”€â”€ CPU: 768, Memory: 1536MB"
echo "â”‚       â”œâ”€â”€ Port: 5001"
echo "â”‚       â””â”€â”€ Health Check: /api/health"
echo "â”œâ”€â”€ ECS Service: chat-app-service"
echo "â”‚   â”œâ”€â”€ Desired Count: 1 (Auto-scaling: 1-3)"
echo "â”‚   â”œâ”€â”€ Launch Type: Fargate"
echo "â”‚   â”œâ”€â”€ Network: awsvpc mode"
echo "â”‚   â””â”€â”€ Security Groups: ALB + ECS"
echo "â””â”€â”€ Application Load Balancer: chat-app-alb"
echo "    â”œâ”€â”€ Listeners: HTTP (Port 80)"
echo "    â”œâ”€â”€ Target Groups:"
echo "    â”‚   â”œâ”€â”€ Frontend TG (Port 3000) - Default /*"
echo "    â”‚   â””â”€â”€ Backend TG (Port 5001) - /api/*"
echo "    â””â”€â”€ Health Checks: HTTP-based"
echo ""

echo -e "${YELLOW}ğŸ”„ CI/CD PIPELINE${NC}"
echo "=================="
echo ""
echo "GitHub Actions Workflow: 'Build & Deploy Multi-Container to ECS'"
echo "â”œâ”€â”€ Trigger: Push to main branch"
echo "â”œâ”€â”€ Build Phase:"
echo "â”‚   â”œâ”€â”€ Build Frontend Docker image (Dockerfile.frontend)"
echo "â”‚   â”œâ”€â”€ Build Backend Docker image (Dockerfile.backend)"
echo "â”‚   â”œâ”€â”€ Push to ECR Public + Private repositories"
echo "â”‚   â””â”€â”€ Tag: latest, git-sha, branch-name"
echo "â”œâ”€â”€ Deploy Phase:"
echo "â”‚   â”œâ”€â”€ Install CDK dependencies (npm install)"
echo "â”‚   â”œâ”€â”€ Compile TypeScript (npm run build)"
echo "â”‚   â”œâ”€â”€ Deploy infrastructure (cdk deploy)"
echo "â”‚   â””â”€â”€ Update ECS service with new images"
echo "â””â”€â”€ Verification:"
echo "    â”œâ”€â”€ Wait for service stability"
echo "    â”œâ”€â”€ Health check validation"
echo "    â””â”€â”€ Output deployment URL"
echo ""

echo -e "${PURPLE}ğŸ“Š MONITORING & OBSERVABILITY${NC}"
echo "=============================="
echo ""
echo "CloudWatch Integration:"
echo "â”œâ”€â”€ Log Groups:"
echo "â”‚   â”œâ”€â”€ /ecs/chat-app (ECS Container logs)"
echo "â”‚   â”‚   â”œâ”€â”€ chat-frontend/* (Next.js logs)"
echo "â”‚   â”‚   â””â”€â”€ chat-backend/* (Flask logs)"
echo "â”‚   â””â”€â”€ /aws/lambda/websocket-* (WebSocket logs)"
echo "â”œâ”€â”€ Metrics:"
echo "â”‚   â”œâ”€â”€ ECS: CPU, Memory, Task count"
echo "â”‚   â”œâ”€â”€ ALB: Request count, Latency, Errors"
echo "â”‚   â””â”€â”€ Lambda: Invocations, Duration, Errors"
echo "â””â”€â”€ Alarms: (Can be configured)"
echo "    â”œâ”€â”€ High CPU/Memory usage"
echo "    â”œâ”€â”€ ALB 5xx errors"
echo "    â””â”€â”€ WebSocket connection failures"
echo ""

echo -e "${CYAN}ğŸŒ NETWORKING${NC}"
echo "=============="
echo ""
echo "VPC Configuration:"
echo "â”œâ”€â”€ VPC: chat-app-vpc"
echo "â”œâ”€â”€ Subnets:"
echo "â”‚   â”œâ”€â”€ Public Subnets (2 AZs) - ALB"
echo "â”‚   â””â”€â”€ Private Subnets (2 AZs) - ECS Tasks"
echo "â”œâ”€â”€ Internet Gateway: Public access"
echo "â”œâ”€â”€ NAT Gateways: Outbound for private subnets"
echo "â””â”€â”€ Security Groups:"
echo "    â”œâ”€â”€ ALB SG: HTTP (80), HTTPS (443) from 0.0.0.0/0"
echo "    â””â”€â”€ ECS SG: Port 3000, 5001 from ALB SG only"
echo ""

echo -e "${GREEN}ğŸ’° COST ESTIMATION${NC}"
echo "=================="
echo ""
echo "Monthly AWS Costs (Estimated):"
echo "â”œâ”€â”€ ECS Fargate:"
echo "â”‚   â”œâ”€â”€ Task (1.25 vCPU, 2GB RAM): ~\$15-25/month"
echo "â”‚   â””â”€â”€ Auto-scaling (1-3 tasks): ~\$15-75/month"
echo "â”œâ”€â”€ Application Load Balancer: ~\$16/month"
echo "â”œâ”€â”€ CloudWatch Logs (retention): ~\$2-5/month"
echo "â”œâ”€â”€ WebSocket API:"
echo "â”‚   â”œâ”€â”€ API Gateway: \$1.00/million messages"
echo "â”‚   â”œâ”€â”€ Lambda: Free tier (1M requests/month)"
echo "â”‚   â””â”€â”€ DynamoDB: Free tier (25GB storage)"
echo "â””â”€â”€ Total Estimated: \$35-100/month"
echo ""
echo "External Services:"
echo "â”œâ”€â”€ MongoDB Atlas: Free tier (512MB)"
echo "â”œâ”€â”€ Domain/DNS: ~\$12/year (optional)"
echo "â””â”€â”€ SSL Certificate: Free (Let's Encrypt)"
echo ""

echo -e "${YELLOW}ğŸ” SECURITY${NC}"
echo "============"
echo ""
echo "Authentication & Authorization:"
echo "â”œâ”€â”€ NextAuth.js (Frontend session management)"
echo "â”œâ”€â”€ JWT tokens (API authentication)"
echo "â”œâ”€â”€ Google OAuth integration"
echo "â”œâ”€â”€ 2FA support (TOTP)"
echo "â””â”€â”€ Role-based access control"
echo ""
echo "Network Security:"
echo "â”œâ”€â”€ VPC private networking"
echo "â”œâ”€â”€ Security group restrictions"
echo "â”œâ”€â”€ ALB SSL termination (configurable)"
echo "â””â”€â”€ MongoDB Atlas network whitelist"
echo ""

echo -e "${BLUE}ğŸ”— IMPORTANT URLs${NC}"
echo "=================="
echo ""
echo "Current Deployment:"
echo "â”œâ”€â”€ Application: http://chat-app-alb-2064082767.us-west-2.elb.amazonaws.com"
echo "â”œâ”€â”€ Health Check: http://chat-app-alb-2064082767.us-west-2.elb.amazonaws.com/api/health"
echo "â”œâ”€â”€ WebSocket: wss://v68x792yd5.execute-api.us-west-2.amazonaws.com/prod"
echo "â””â”€â”€ MongoDB: mongodb+srv://connectbest.fyufpj1.mongodb.net"
echo ""
echo "GitHub Repository:"
echo "â”œâ”€â”€ Source: https://github.com/ConnectBest/chat"
echo "â”œâ”€â”€ Actions: https://github.com/ConnectBest/chat/actions"
echo "â””â”€â”€ Releases: https://github.com/ConnectBest/chat/releases"
echo ""

echo -e "${GREEN}âœ… DEPLOYMENT STATUS${NC}"
echo "===================="
echo ""
if command -v gh &> /dev/null && gh auth status &> /dev/null; then
    echo "Latest GitHub Actions Run:"
    gh run list --limit 1 --json status,name,createdAt,conclusion,url | jq -r '.[] | "â”œâ”€â”€ Status: \(.status // "unknown") | \(.conclusion // "running") | \(.name) | \(.createdAt) | \(.url)"' 2>/dev/null || echo "â”œâ”€â”€ Unable to fetch GitHub Actions status"
else
    echo "â”œâ”€â”€ GitHub CLI not available or not authenticated"
fi
echo ""

echo -e "${CYAN}ğŸ“š DOCUMENTATION${NC}"
echo "=================="
echo ""
echo "Key Documentation Files:"
echo "â”œâ”€â”€ README.md - Project overview"
echo "â”œâ”€â”€ CLAUDE.md - Architecture guide for Claude Code"
echo "â”œâ”€â”€ DEPLOYMENT_GUIDE.md - Manual deployment steps"
echo "â”œâ”€â”€ backend/README.md - Backend API documentation"
echo "â”œâ”€â”€ websocket-api/README.md - WebSocket deployment guide"
echo "â””â”€â”€ infrastructure/ - AWS CDK infrastructure as code"
echo ""

echo -e "${YELLOW}ğŸ› ï¸  DEVELOPMENT WORKFLOW${NC}"
echo "========================="
echo ""
echo "Local Development:"
echo "â”œâ”€â”€ Frontend: npm run dev (Port 3000)"
echo "â”œâ”€â”€ Backend: cd backend && python app.py (Port 5001)"
echo "â”œâ”€â”€ Database: MongoDB Atlas (Cloud)"
echo "â””â”€â”€ WebSocket: Deploy separately with SAM CLI"
echo ""
echo "Production Deployment:"
echo "â”œâ”€â”€ Push to main branch"
echo "â”œâ”€â”€ GitHub Actions triggers automatically"
echo "â”œâ”€â”€ Multi-container images built and pushed"
echo "â”œâ”€â”€ CDK deploys infrastructure updates"
echo "â””â”€â”€ ECS service updates with zero-downtime"
echo ""

echo -e "${GREEN}ğŸ‰ ARCHITECTURE OVERVIEW COMPLETE${NC}"
echo "=================================="
echo ""
echo "This multi-container microservices architecture provides:"
echo "âœ… Scalability: Auto-scaling ECS tasks based on demand"
echo "âœ… Reliability: Multi-AZ deployment with health checks"
echo "âœ… Performance: CDN-ready static assets, efficient caching"
echo "âœ… Security: VPC networking, IAM roles, encrypted data"
echo "âœ… Maintainability: Infrastructure as Code, CI/CD automation"
echo "âœ… Cost-Effective: Pay-per-use serverless components"
echo ""
echo "ğŸ”— Current Application: http://chat-app-alb-2064082767.us-west-2.elb.amazonaws.com"
echo ""